document.addEventListener('DOMContentLoaded', () => {
    // ==========================================================================
    // == CONFIGURAZIONE E COSTANTI ==
    // ==========================================================================
    const STORAGE_KEY = 'travelPlannerPro_Trips_vFinal_NoImport';
    const DEFAULT_CURRENCY = 'EUR';
    const DEFAULT_LOCALE = 'it-IT';
    const PREDEFINED_PACKING_LISTS = {
        beach: ["Costume da bagno", "Asciugamano da spiaggia", "Crema solare", "Occhiali da sole", "Cappello", "Libro/Rivista", "Borsa da spiaggia", "Infradito/Sandali", "Dopasole"],
        city: ["Scarpe comode", "Mappa/App navigazione", "Macchina fotografica", "Power bank", "Borraccia", "Giacca leggera/Impermeabile", "Zainetto", "Documenti", "Adattatore presa (se necessario)"],
        mountain: ["Scarponcini da trekking", "Zaino", "Borraccia/Thermos", "Giacca a vento/pioggia", "Pile/Maglione pesante", "Pantaloni lunghi", "Cappello/Berretto", "Guanti", "Occhiali da sole", "Crema solare", "Kit primo soccorso", "Mappa/Bussola/GPS"],
        camping: ["Tenda", "Sacco a pelo", "Materassino", "Fornello da campeggio + Gas", "Gavetta/Stoviglie", "Coltellino multiuso", "Torcia frontale/Lanterna + Batterie", "Kit igiene personale", "Asciugamano microfibra", "Repellente insetti", "Sedia pieghevole (opzionale)", "Cibo a lunga conservazione"]
    };

    // ==========================================================================
    // == ELEMENTI DOM ==
    // ==========================================================================
    const tripListUl = document.getElementById('trip-list');
    const newTripBtn = document.getElementById('new-trip-btn');
    const welcomeMessageDiv = document.getElementById('welcome-message');
    const tripDetailsAreaDiv = document.getElementById('trip-details-area');
    const noTripsMessage = document.getElementById('no-trips-message');
    const tripTitleH2 = document.getElementById('trip-title');
    const downloadTextBtn = document.getElementById('download-text-btn');
    const downloadExcelBtn = document.getElementById('download-excel-btn');
    const deleteTripBtn = document.getElementById('delete-trip-btn');
    const tabsContainer = document.querySelector('.tabs');
    const tripInfoForm = document.getElementById('trip-info-form');
    const editTripIdInput = document.getElementById('edit-trip-id');
    const tripNameInput = document.getElementById('trip-name');
    const tripOriginIataInput = document.getElementById('trip-origin-iata'); // Ora in Info tab
    const tripDestinationIataInput = document.getElementById('trip-destination-iata'); // Ora in Info tab
    const tripStartDateInput = document.getElementById('trip-start-date');
    const tripEndDateInput = document.getElementById('trip-end-date');
    const tripNotesTextarea = document.getElementById('trip-notes');
    const addTransportItemForm = document.getElementById('add-transport-item-form');
    const editTransportItemIdInput = document.getElementById('edit-transport-item-id');
    const transportTypeSelect = document.getElementById('transport-type');
    const transportDescriptionInput = document.getElementById('transport-description');
    const transportDepartureLocInput = document.getElementById('transport-departure-loc');
    const transportDepartureDatetimeInput = document.getElementById('transport-departure-datetime');
    const transportArrivalLocInput = document.getElementById('transport-arrival-loc');
    const transportArrivalDatetimeInput = document.getElementById('transport-arrival-datetime');
    const transportBookingRefInput = document.getElementById('transport-booking-ref');
    const transportCostInput = document.getElementById('transport-cost');
    const transportNotesInput = document.getElementById('transport-notes');
    const transportListUl = document.getElementById('transport-list');
    const noTransportItemsP = document.getElementById('no-transport-items');
    const transportSubmitBtn = document.getElementById('transport-submit-btn');
    const transportCancelEditBtn = document.getElementById('transport-cancel-edit-btn');
    const addItineraryItemForm = document.getElementById('add-itinerary-item-form');
    const editItineraryItemIdInput = document.getElementById('edit-itinerary-item-id');
    const itineraryDayInput = document.getElementById('itinerary-day');
    const itineraryTimeInput = document.getElementById('itinerary-time');
    const itineraryActivityInput = document.getElementById('itinerary-activity');
    const itineraryLocationInput = document.getElementById('itinerary-location');
    const itineraryNotesInput = document.getElementById('itinerary-notes');
    const itineraryListUl = document.getElementById('itinerary-list');
    const noItineraryItemsP = document.getElementById('no-itinerary-items');
    const itinerarySubmitBtn = document.getElementById('itinerary-submit-btn');
    const itineraryCancelEditBtn = document.getElementById('itinerary-cancel-edit-btn');
    const addBudgetItemForm = document.getElementById('add-budget-item-form');
    const editBudgetItemIdInput = document.getElementById('edit-budget-item-id');
    const budgetCategorySelect = document.getElementById('budget-category');
    const budgetDescriptionInput = document.getElementById('budget-description');
    const budgetEstimatedInput = document.getElementById('budget-estimated');
    const budgetActualInput = document.getElementById('budget-actual');
    const budgetListUl = document.getElementById('budget-list');
    const budgetTotalEstimatedStrong = document.getElementById('budget-total-estimated');
    const budgetTotalActualStrong = document.getElementById('budget-total-actual');
    const budgetDifferenceStrong = document.getElementById('budget-difference');
    const noBudgetItemsP = document.getElementById('no-budget-items');
    const budgetSubmitBtn = document.getElementById('budget-submit-btn');
    const budgetCancelEditBtn = document.getElementById('budget-cancel-edit-btn');
    const predefinedChecklistsContainer = document.querySelector('.predefined-checklists');
    const addPackingItemForm = document.getElementById('add-packing-item-form');
    const editPackingItemIdInput = document.getElementById('edit-packing-item-id');
    const packingItemNameInput = document.getElementById('packing-item-name');
    const packingListUl = document.getElementById('packing-list');
    const noPackingItemsP = document.getElementById('no-packing-items');
    const packingSubmitBtn = document.getElementById('packing-submit-btn');
    const packingCancelEditBtn = document.getElementById('packing-cancel-edit-btn');
    const newTripModal = document.getElementById('new-trip-modal');
    const newTripNameInput = document.getElementById('new-trip-name-input');
    const newTripErrorP = document.getElementById('new-trip-modal-error');
    const createTripConfirmBtn = document.getElementById('create-trip-confirm-btn');
    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmationModalTitle = document.getElementById('confirmation-modal-title');
    const confirmationModalMessage = document.getElementById('confirmation-modal-message');
    const confirmationModalConfirmBtn = document.getElementById('confirmation-modal-confirm-btn');
    const toastContainer = document.getElementById('toast-container');
    const addTransportTotalToBudgetBtn = document.getElementById('add-transport-total-to-budget-btn');
    const searchSkyscannerBtn = document.getElementById('search-skyscanner-btn'); // Ora nel Tab Trasporti

    // ==========================================================================
    // == STATO APPLICAZIONE ==
    // ==========================================================================
    let trips = [];
    let currentTripId = null;
    let editingItemId = { transport: null, itinerary: null, budget: null, packing: null };
    let confirmActionCallback = null;

    // ==========================================================================
    // == FUNZIONI UTILITY ==
    // ==========================================================================
    const generateId = (prefix = 'item') => `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    const formatCurrency = (amount) => { const num = amount === null || typeof amount === 'undefined' ? 0 : Number(amount); if (isNaN(num)) { console.warn(`Valore non numerico per formatCurrency: ${amount}`); return new Intl.NumberFormat(DEFAULT_LOCALE, { style: 'currency', currency: DEFAULT_CURRENCY }).format(0); } return new Intl.NumberFormat(DEFAULT_LOCALE, { style: 'currency', currency: DEFAULT_CURRENCY }).format(num); };
    const formatDate = (dateString) => { if (!dateString || typeof dateString !== 'string') return ''; try { const parts = dateString.split('-'); if (parts.length !== 3) return ''; const year = parseInt(parts[0]), month = parseInt(parts[1]), day = parseInt(parts[2]); if (isNaN(year) || isNaN(month) || isNaN(day) || month < 1 || month > 12 || day < 1 || day > 31) return ''; const date = new Date(Date.UTC(year, month - 1, day)); if (isNaN(date.getTime()) || date.getUTCFullYear() !== year || date.getUTCMonth() + 1 !== month || date.getUTCDate() !== day) return ''; return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`; } catch (e) { return ''; } };
    const formatDateTime = (dateTimeString) => { if (!dateTimeString || typeof dateTimeString !== 'string') return ''; try { const date = new Date(dateTimeString); if (isNaN(date.getTime())) return ''; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${day}/${month}/${year} ${hours}:${minutes}`; } catch (e) { return ''; } };
    const formatSkyscannerDate = (isoDateString) => { if (!isoDateString || typeof isoDateString !== 'string' || !isoDateString.match(/^\d{4}-\d{2}-\d{2}$/)) return null; try { const year = isoDateString.substring(2, 4); const month = isoDateString.substring(5, 7); const day = isoDateString.substring(8, 10); return `${year}${month}${day}`; } catch (e) { console.error("Errore formattazione data Skyscanner:", e); return null; } };
    const showToast = (message, type = 'info') => { if (!toastContainer) return; const toast = document.createElement('div'); toast.className = `toast ${type}`; let iconClass = 'fas fa-info-circle'; if (type === 'success') iconClass = 'fas fa-check-circle'; if (type === 'error') iconClass = 'fas fa-exclamation-circle'; toast.innerHTML = `<i class="${iconClass}"></i> ${message}`; toastContainer.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove(), { once: true }); }, 3000); };
    const openNewTripModal = () => { if (!newTripModal) return; newTripNameInput.value = ''; if (newTripErrorP) newTripErrorP.style.display = 'none'; newTripModal.style.display = 'block'; newTripNameInput.focus(); };
    const closeNewTripModal = () => { if (newTripModal) newTripModal.style.display = 'none'; };
    const showConfirmationModal = (title, message, onConfirm) => { if (!confirmationModal) return; confirmationModalTitle.textContent = title; confirmationModalMessage.textContent = message; confirmActionCallback = onConfirm; confirmationModal.style.display = 'block'; };
    const closeConfirmationModal = () => { if (!confirmationModal) return; confirmActionCallback = null; confirmationModal.style.display = 'none'; };
    const resetEditState = (formType) => {
        editingItemId[formType] = null;
        const form = document.getElementById(`add-${formType}-item-form`); const submitBtn = document.getElementById(`${formType}-submit-btn`);
        const cancelBtn = document.getElementById(`${formType}-cancel-edit-btn`); const hiddenInput = document.getElementById(`edit-${formType}-item-id`);
        if (form) form.reset(); if(hiddenInput) hiddenInput.value = '';
        if (submitBtn) { let addText = 'Aggiungi'; if(formType === 'transport') addText = 'Trasporto'; else if(formType === 'itinerary') addText = 'Attività'; else if(formType === 'budget') addText = 'Spesa'; else if(formType === 'packing') addText = 'Oggetto'; submitBtn.innerHTML = `<i class="fas fa-plus"></i> ${addText}`; submitBtn.classList.remove('btn-warning'); submitBtn.classList.add('btn-secondary'); }
        if (cancelBtn) cancelBtn.style.display = 'none';
    };

    // ==========================================================================
    // == GESTIONE STORAGE ==
    // ==========================================================================
    const saveTrips = () => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(trips)); } catch (e) { console.error("Errore salvataggio:", e); showToast("Errore: impossibile salvare i dati.", "error"); } };
    const loadTrips = () => {
        const stored = localStorage.getItem(STORAGE_KEY); try { trips = stored ? JSON.parse(stored) : []; if (!Array.isArray(trips)) trips = []; } catch (e) { console.error("Errore parsing localStorage:", e); trips = []; }
        trips.forEach(trip => { if (!trip || typeof trip !== 'object') return; trip.originIata = trip.originIata || ''; trip.destinationIata = trip.destinationIata || ''; trip.transportations = Array.isArray(trip.transportations) ? trip.transportations : []; trip.itinerary = Array.isArray(trip.itinerary) ? trip.itinerary : []; trip.budget = (trip.budget && typeof trip.budget === 'object') ? trip.budget : { items: [], estimatedTotal: 0, actualTotal: 0 }; trip.budget.items = Array.isArray(trip.budget.items) ? trip.budget.items : []; trip.packingList = Array.isArray(trip.packingList) ? trip.packingList : []; });
    };

    // ==========================================================================
    // == LOGICA VIAGGI (CRUD, Selezione) ==
    // ==========================================================================
    const findTripById = (id) => trips.find(trip => trip && trip.id === id);

    const renderTripList = () => {
        tripListUl.innerHTML = ''; trips.sort((a, b) => (a?.name || '').localeCompare(b?.name || ''));
        trips.forEach(trip => { if (!trip || !trip.id) return; const li = document.createElement('li'); li.dataset.tripId = trip.id; li.innerHTML = `<span>${trip.name || 'Senza Nome'} (${formatDate(trip.startDate)} - ${formatDate(trip.endDate)})</span> <button class="btn-delete-trip" data-trip-id="${trip.id}" title="Elimina"><i class="fas fa-trash-alt"></i></button>`; if (trip.id === currentTripId) li.classList.add('active'); li.addEventListener('click', (e) => { if (!e.target.closest('.btn-delete-trip')) selectTrip(trip.id); }); li.querySelector('.btn-delete-trip').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteTrip(trip.id); }); tripListUl.appendChild(li); });
        noTripsMessage.style.display = trips.length === 0 ? 'block' : 'none';
    };

    const selectTrip = (id) => { if (currentTripId === id && tripDetailsAreaDiv.style.display !== 'none') return; currentTripId = id; const trip = findTripById(id); if (trip) { renderTripList(); renderTripDetails(trip); tripDetailsAreaDiv.style.display = 'block'; welcomeMessageDiv.style.display = 'none'; Object.keys(editingItemId).forEach(resetEditState); switchTab('info-tab'); } else { deselectTrip(); } };
    const deselectTrip = () => { currentTripId = null; tripDetailsAreaDiv.style.display = 'none'; welcomeMessageDiv.style.display = 'block'; downloadTextBtn.disabled = true; downloadExcelBtn.disabled = true; deleteTripBtn.disabled = true; renderTripList(); };
    const renderTripDetails = (trip) => { if (!trip) { deselectTrip(); return; } tripTitleH2.textContent = trip.name || 'Senza Nome'; editTripIdInput.value = trip.id; tripNameInput.value = trip.name || ''; tripOriginIataInput.value = trip.originIata || ''; tripDestinationIataInput.value = trip.destinationIata || ''; tripStartDateInput.value = trip.startDate || ''; tripEndDateInput.value = trip.endDate || ''; tripNotesTextarea.value = trip.notes || ''; renderTransportations(trip.transportations); renderItinerary(trip.itinerary); renderBudget(trip.budget); renderPackingList(trip.packingList); downloadTextBtn.disabled = false; downloadExcelBtn.disabled = false; deleteTripBtn.disabled = false; };
    const handleNewTrip = () => { openNewTripModal(); };
    const handleCreateTripConfirm = () => { const tripName = newTripNameInput.value.trim(); if (tripName) { if (newTripErrorP) newTripErrorP.style.display = 'none'; const newTrip = { id: generateId('trip'), name: tripName, originIata: '', destinationIata: '', startDate: '', endDate: '', notes: '', transportations: [], itinerary: [], budget: { items: [], estimatedTotal: 0, actualTotal: 0 }, packingList: [] }; trips.push(newTrip); saveTrips(); closeNewTripModal(); selectTrip(newTrip.id); showToast(`Viaggio "${tripName}" creato!`, 'success'); } else { if (newTripErrorP) { newTripErrorP.textContent = 'Il nome non può essere vuoto.'; newTripErrorP.style.display = 'block'; } newTripNameInput.focus(); } };
    const handleSaveTripInfo = (e) => { e.preventDefault(); if (!currentTripId) return; const trip = findTripById(currentTripId); if (trip) { const start = tripStartDateInput.value, end = tripEndDateInput.value; if (start && end && start > end) { showToast('Data fine non valida.', 'error'); return; } const originIata = (tripOriginIataInput.value || '').substring(0, 3).toUpperCase(); const destinationIata = (tripDestinationIataInput.value || '').substring(0, 3).toUpperCase(); if ( (originIata && originIata.length !== 3) || (destinationIata && destinationIata.length !== 3) ) { showToast('I codici IATA devono essere di 3 lettere.', 'warning'); } trip.name = tripNameInput.value.trim() || 'Viaggio S.N.'; trip.originIata = originIata; trip.destinationIata = destinationIata; trip.startDate = start; trip.endDate = end; trip.notes = tripNotesTextarea.value.trim(); saveTrips(); tripTitleH2.textContent = trip.name; renderTripList(); showToast('Informazioni salvate!', 'success'); } };
    const handleDeleteTrip = (id) => { const item = findTripById(id); if (!item) return; showConfirmationModal( 'Conferma Eliminazione Viaggio', `Eliminare "${item.name || 'S.N.'}"? L'azione è irreversibile.`, () => { trips = trips.filter(trip => trip.id !== id); saveTrips(); if (currentTripId === id) deselectTrip(); else renderTripList(); showToast('Viaggio eliminato.', 'info'); }); };

    // ==========================================================================
    // == FUNZIONI MODIFICA ITEM (Generica) ==
    // ==========================================================================
    const startEditItem = (listType, itemId) => { if (!currentTripId) return; const trip = findTripById(currentTripId); if (!trip) return; let itemToEdit = null; let list = []; switch (listType) { case 'transport': list = trip.transportations; break; case 'itinerary': list = trip.itinerary; break; case 'budget': list = trip.budget.items; break; case 'packing': list = trip.packingList; break; default: return; } if (!Array.isArray(list)) { console.error(`Lista ${listType} non array`); return; } itemToEdit = list.find(item => item && item.id === itemId); if (!itemToEdit) { console.error(`Item ${itemId} non trovato`); return; } Object.keys(editingItemId).forEach(type => { if (type !== listType) resetEditState(type); }); editingItemId[listType] = itemId; const form = document.getElementById(`add-${listType}-item-form`); const submitBtn = document.getElementById(`${listType}-submit-btn`); const cancelBtn = document.getElementById(`${listType}-cancel-edit-btn`); const hiddenInput = document.getElementById(`edit-${listType}-item-id`); if(hiddenInput) hiddenInput.value = itemId; try { switch (listType) { case 'transport': transportTypeSelect.value = itemToEdit.type || 'Altro'; transportDescriptionInput.value = itemToEdit.description || ''; transportDepartureLocInput.value = itemToEdit.departureLoc || ''; transportDepartureDatetimeInput.value = itemToEdit.departureDateTime || ''; transportArrivalLocInput.value = itemToEdit.arrivalLoc || ''; transportArrivalDatetimeInput.value = itemToEdit.arrivalDateTime || ''; transportBookingRefInput.value = itemToEdit.bookingRef || ''; transportCostInput.value = itemToEdit.cost ?? ''; transportNotesInput.value = itemToEdit.notes || ''; break; case 'itinerary': itineraryDayInput.value = itemToEdit.day || ''; itineraryTimeInput.value = itemToEdit.time || ''; itineraryActivityInput.value = itemToEdit.activity || ''; itineraryLocationInput.value = itemToEdit.location || ''; itineraryNotesInput.value = itemToEdit.notes || ''; break; case 'budget': budgetCategorySelect.value = itemToEdit.category || 'Altro'; budgetDescriptionInput.value = itemToEdit.description || ''; budgetEstimatedInput.value = itemToEdit.estimated ?? ''; budgetActualInput.value = itemToEdit.actual ?? ''; break; case 'packing': packingItemNameInput.value = itemToEdit.name || ''; break; } } catch (error) { console.error(`Errore popolamento form ${listType}:`, error); showToast(`Errore caricamento dati.`, 'error'); resetEditState(listType); return; } if (submitBtn) { submitBtn.innerHTML = '<i class="fas fa-save"></i> Salva Modifiche'; submitBtn.classList.remove('btn-secondary'); submitBtn.classList.add('btn-warning'); } if (cancelBtn) cancelBtn.style.display = 'inline-flex'; form.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); };
    const handleItemFormSubmit = (e, listType) => { e.preventDefault(); if (!currentTripId) return; const trip = findTripById(currentTripId); if (!trip) return; const currentEditId = editingItemId[listType]; let itemData = {}; let list = []; let listOwner = trip; let renderFn; switch (listType) { case 'transport': trip.transportations = Array.isArray(trip.transportations)?trip.transportations:[]; list = trip.transportations; renderFn = renderTransportations; break; case 'itinerary': trip.itinerary = Array.isArray(trip.itinerary)?trip.itinerary:[]; list = trip.itinerary; renderFn = renderItinerary; break; case 'budget': trip.budget = (trip.budget&&typeof trip.budget==='object')?trip.budget:{items:[]}; trip.budget.items=Array.isArray(trip.budget.items)?trip.budget.items:[]; list=trip.budget.items; listOwner=trip.budget; renderFn = renderBudget; break; case 'packing': trip.packingList = Array.isArray(trip.packingList)?trip.packingList:[]; list = trip.packingList; renderFn = renderPackingList; break; default: console.error("Tipo lista non valido:", listType); return; } try { switch (listType) { case 'transport': if (!transportDescriptionInput.value.trim()) throw new Error("Descrizione richiesta."); itemData = { type: transportTypeSelect.value, description: transportDescriptionInput.value.trim(), departureLoc: transportDepartureLocInput.value.trim() || null, departureDateTime: transportDepartureDatetimeInput.value || null, arrivalLoc: transportArrivalLocInput.value.trim() || null, arrivalDateTime: transportArrivalDatetimeInput.value || null, bookingRef: transportBookingRefInput.value.trim() || null, cost: transportCostInput.value === '' ? null : parseFloat(transportCostInput.value), notes: transportNotesInput.value.trim() || null }; if (itemData.cost !== null && (isNaN(itemData.cost) || itemData.cost < 0)) throw new Error("Costo non valido."); break; case 'itinerary': if (!itineraryDayInput.value || !itineraryActivityInput.value.trim()) throw new Error("Giorno e attività richiesti."); if (trip.startDate && trip.endDate && itineraryDayInput.value && (itineraryDayInput.value < trip.startDate || itineraryDayInput.value > trip.endDate)) throw new Error(`Data fuori dal periodo viaggio.`); itemData = { day: itineraryDayInput.value, time: itineraryTimeInput.value || null, activity: itineraryActivityInput.value.trim(), location: itineraryLocationInput.value.trim() || null, notes: itineraryNotesInput.value.trim() || null }; break; case 'budget': const estR = budgetEstimatedInput.value; const actR = budgetActualInput.value; const est = parseFloat(estR); const act = actR === '' ? null : parseFloat(actR); if (!budgetDescriptionInput.value.trim() || isNaN(est) || est < 0) throw new Error("Descrizione/costo stimato non validi."); if (act !== null && isNaN(act)) throw new Error("Costo effettivo non è numero."); if (act !== null && act < 0) throw new Error("Costo effettivo non può essere negativo."); itemData = { category: budgetCategorySelect.value, description: budgetDescriptionInput.value.trim(), estimated: est, actual: act }; break; case 'packing': if (!packingItemNameInput.value.trim()) throw new Error("Nome oggetto richiesto."); itemData = { name: packingItemNameInput.value.trim() }; break; } } catch (error) { showToast(`Errore: ${error.message}`, 'error'); return; } if (currentEditId) { const idx = list.findIndex(i => i && i.id === currentEditId); if (idx > -1) list[idx] = { ...list[idx], ...itemData }; else { console.error(`Item ${currentEditId} non trovato`); return;} } else { itemData.id = generateId(listType); if(listType === 'packing') itemData.packed = false; if (Array.isArray(list)) { list.push(itemData); } else { console.error(`Lista ${listType} non array`); showToast("Errore interno.", "error"); return; } } saveTrips(); if (listType === 'budget') { renderFn(listOwner); } else { renderFn(list); } resetEditState(listType); showToast(currentEditId ? 'Elemento aggiornato!' : 'Elemento aggiunto!', 'success'); };

    // ==========================================================================
    // == FUNZIONI RENDER LISTE ==
    // ==========================================================================
    const renderTransportations = (transportItemsInput) => { const items = Array.isArray(transportItemsInput) ? transportItemsInput : []; if (!transportListUl) { console.error("Elemento transport-list non trovato!"); return; } transportListUl.innerHTML = ''; if(noTransportItemsP) noTransportItemsP.style.display = items.length === 0 ? 'block' : 'none'; if (!Array.isArray(items)) { console.error("renderTransportations: input non array"); return; } try { items.sort((a, b) => (a?.departureDateTime || '').localeCompare(b?.departureDateTime || '')); } catch (e) { console.error("Errore sort trasporti:", e); } items.forEach(item => { if (!item || !item.id) return; const li = document.createElement('li'); li.dataset.itemId = item.id; const iconClass = getTransportIcon(item.type); li.innerHTML = ` <div class="item-details"> <strong><i class="fas ${iconClass} fa-fw"></i> ${item.type}: ${item.description || 'N/D'}</strong> <span class="meta"><i class="fas fa-plane-departure fa-fw"></i> Da: ${item.departureLoc || '?'} (${formatDateTime(item.departureDateTime)})</span> <span class="meta"><i class="fas fa-plane-arrival fa-fw"></i> A: ${item.arrivalLoc || '?'} (${formatDateTime(item.arrivalDateTime)})</span> ${item.bookingRef ? `<span class="meta"><i class="fas fa-ticket-alt fa-fw"></i> Rif: ${item.bookingRef}</span>`:''} ${item.cost!==null ? `<span class="meta"><i class="fas fa-euro-sign fa-fw"></i> Costo: ${formatCurrency(item.cost)}</span>`:''} ${item.notes ? `<span class="meta"><i class="fas fa-info-circle fa-fw"></i> Note: ${item.notes}</span>`:''} </div> <div class="item-actions"> <button class="btn-icon edit transport-edit-btn" data-item-id="${item.id}" title="Modifica"><i class="fas fa-edit"></i></button> <button class="btn-icon delete transport-delete-btn" data-item-id="${item.id}" title="Elimina"><i class="fas fa-trash-alt"></i></button> </div>`; transportListUl.appendChild(li); }); };
    const getTransportIcon = (type) => { switch(type) { case 'Volo': return 'fa-plane-departure'; case 'Treno': return 'fa-train'; case 'Auto': return 'fa-car'; case 'Bus': return 'fa-bus-alt'; case 'Traghetto': return 'fa-ship'; case 'Metro/Mezzi Pubblici': return 'fa-subway'; case 'Taxi/Ride Sharing': return 'fa-taxi'; default: return 'fa-road'; } };
    const renderItinerary = (itineraryItemsInput) => { const items = Array.isArray(itineraryItemsInput) ? itineraryItemsInput : []; if (!itineraryListUl) { console.error("Elemento itinerary-list non trovato!"); return; } itineraryListUl.innerHTML = ''; if(noItineraryItemsP) noItineraryItemsP.style.display = items.length === 0 ? 'block' : 'none'; if (!Array.isArray(items)) { console.error("renderItinerary: input non array"); return; } try { items.sort((a, b) => { const d=(a?.day||'').localeCompare(b?.day||''); return d!==0?d:(a?.time||'').localeCompare(b?.time||''); }); } catch (e) { console.error("Errore sort itinerario:", e); } items.forEach(item => { if (!item || !item.id) return; const li = document.createElement('li'); li.dataset.itemId = item.id; li.innerHTML = ` <div class="item-details"> <strong>${formatDate(item.day)} ${item.time?'('+item.time+')':''} - ${item.activity||'N/D'}</strong> ${item.location ? `<span class="meta"><i class="fas fa-map-marker-alt fa-fw"></i> ${item.location}</span>`:''} ${item.notes ? `<span class="meta"><i class="fas fa-info-circle fa-fw"></i> ${item.notes}</span>`:''} </div> <div class="item-actions"> <button class="btn-icon edit itinerary-edit-btn" data-item-id="${item.id}" title="Modifica"><i class="fas fa-edit"></i></button> <button class="btn-icon delete itinerary-delete-btn" data-item-id="${item.id}" title="Elimina"><i class="fas fa-trash-alt"></i></button> </div>`; itineraryListUl.appendChild(li); }); if (!editingItemId.itinerary) { addItineraryItemForm.reset(); const trip = findTripById(currentTripId); if (trip?.startDate) itineraryDayInput.value = trip.startDate; } };
    const renderBudget = (budgetData) => { const safeBudgetData = budgetData && typeof budgetData === 'object' ? budgetData : { items: [], estimatedTotal: 0, actualTotal: 0 }; const items = Array.isArray(safeBudgetData.items) ? safeBudgetData.items : []; if (!budgetListUl) { console.error("Elemento budget-list non trovato!"); return; } budgetListUl.innerHTML = ''; if(noBudgetItemsP) noBudgetItemsP.style.display = items.length === 0 ? 'block' : 'none'; let calcEst = 0; let calcAct = 0; if (!Array.isArray(items)) { console.error("renderBudget: items non array"); return; } try { items.sort((a, b) => (a?.category||'').localeCompare(b?.category||'')); } catch (e) { console.error("Errore sort budget:", e); } items.forEach(item => { if (!item || !item.id) return; const est = Number(item.estimated || 0); const act = item.actual === null || typeof item.actual === 'undefined' ? null : Number(item.actual || 0); if (!isNaN(est)) calcEst += est; if (act !== null && !isNaN(act)) calcAct += act; let cls = ''; if (act !== null && !isNaN(act) && est > 0) { if (act > est) cls = 'negative'; else if (act < est) cls = 'positive'; } const li = document.createElement('li'); li.dataset.itemId = item.id; li.innerHTML = ` <div class="item-details"> <strong>${item.category||'N/D'}: ${item.description||'N/D'}</strong> <span class="meta">Stimato: ${formatCurrency(est)} | Effettivo: <span class="${cls}">${act === null ? 'N/A' : formatCurrency(act)}</span></span> </div> <div class="item-actions"> <button class="btn-icon edit budget-edit-btn" data-item-id="${item.id}" title="Modifica"><i class="fas fa-edit"></i></button> <button class="btn-icon delete budget-delete-btn" data-item-id="${item.id}" title="Elimina"><i class="fas fa-trash-alt"></i></button> </div>`; budgetListUl.appendChild(li); }); if(budgetTotalEstimatedStrong) budgetTotalEstimatedStrong.textContent = formatCurrency(calcEst); if(budgetTotalActualStrong) budgetTotalActualStrong.textContent = formatCurrency(calcAct); const diff = calcAct - calcEst; if (budgetDifferenceStrong) { budgetDifferenceStrong.textContent = formatCurrency(diff); budgetDifferenceStrong.className = ''; if (diff < 0) budgetDifferenceStrong.classList.add('positive'); else if (diff > 0) budgetDifferenceStrong.classList.add('negative'); } const trip = findTripById(currentTripId); if (trip?.budget) { trip.budget.estimatedTotal = calcEst; trip.budget.actualTotal = calcAct; } if (!editingItemId.budget) { addBudgetItemForm.reset(); } };
    const renderPackingList = (itemsInput = []) => { const items = Array.isArray(itemsInput) ? itemsInput : []; if (!packingListUl) { console.error("Elemento packing-list non trovato!"); return; } packingListUl.innerHTML = ''; if(noPackingItemsP) noPackingItemsP.style.display = items.length === 0 ? 'block' : 'none'; if (!Array.isArray(items)) { console.error("renderPackingList: input non array"); return; } try { items.sort((a, b) => (a?.name||'').localeCompare(b?.name||'')); } catch(e) { console.error("Errore sort packing list:", e); } items.forEach(item => { if (!item || !item.id) return; const li = document.createElement('li'); li.dataset.itemId = item.id; li.classList.toggle('packed', item.packed); li.innerHTML = ` <div class="form-check"> <input class="form-check-input packing-checkbox" type="checkbox" id="pack-${item.id}" data-item-id="${item.id}" ${item.packed?'checked':''}> <label class="form-check-label" for="pack-${item.id}">${item.name||'N/D'}</label> </div> <div class="item-actions"> <button class="btn-icon edit packing-edit-btn" data-item-id="${item.id}" title="Modifica Nome"><i class="fas fa-edit"></i></button> <button class="btn-icon delete packing-delete-btn" data-item-id="${item.id}" title="Elimina"><i class="fas fa-trash-alt"></i></button> </div>`; packingListUl.appendChild(li); }); if (!editingItemId.packing) { addPackingItemForm.reset(); } };
    const handleTogglePacked = (itemId, isPacked) => { if (!currentTripId) return; const trip = findTripById(currentTripId); if (!trip) return; trip.packingList = Array.isArray(trip.packingList) ? trip.packingList : []; const idx = trip.packingList.findIndex(i => i && i.id === itemId); if (idx > -1) { trip.packingList[idx].packed = isPacked; saveTrips(); } };
    const handleImportPackingList = (type) => { if (!currentTripId || !PREDEFINED_PACKING_LISTS[type]) return; const trip = findTripById(currentTripId); if (!trip) return; const predefined = PREDEFINED_PACKING_LISTS[type]; let added = 0; trip.packingList = Array.isArray(trip.packingList) ? trip.packingList : []; const currentLower = trip.packingList.map(i => (i?.name || '').toLowerCase()); predefined.forEach(name => { if (!currentLower.includes(name.toLowerCase())) { trip.packingList.push({ id: generateId('pack'), name: name, packed: false }); added++; }}); if (added > 0) { saveTrips(); renderPackingList(trip.packingList); showToast(`${added} oggetti aggiunti!`, 'success'); } else { showToast(`Nessun nuovo oggetto da aggiungere.`, 'info'); } };
    const handleDeleteItem = (listType, itemId) => { if (!currentTripId) return; const trip = findTripById(currentTripId); if (!trip) return; let list, renderFunction, listOwner = trip; let itemName = "voce"; switch(listType) { case 'transport': list = trip.transportations; renderFunction = renderTransportations; itemName="trasporto"; break; case 'itinerary': list = trip.itinerary; renderFunction = renderItinerary; itemName="attività"; break; case 'budget': list = trip.budget.items; renderFunction = renderBudget; listOwner = trip.budget; itemName="spesa"; break; case 'packing': list = trip.packingList; renderFunction = renderPackingList; itemName="oggetto"; break; default: return; } if (!Array.isArray(list)) { console.error(`handleDeleteItem: ${listType} non array`); return; } const itemIndex = list.findIndex(item => item && item.id === itemId); if (itemIndex > -1) { const itemDesc = list[itemIndex].description || list[itemIndex].activity || list[itemIndex].name || `ID: ${itemId}`; showConfirmationModal( `Conferma Eliminazione ${itemName}`, `Eliminare "${itemDesc}"?`, () => { list.splice(itemIndex, 1); saveTrips(); if (listType === 'budget') { renderFunction(listOwner); } else { renderFunction(list); } if (editingItemId[listType] === itemId) resetEditState(listType); showToast(`${itemName.charAt(0).toUpperCase() + itemName.slice(1)} eliminato/a.`, 'info'); }); } };

    // ==========================================================================
    // == FUNZIONE AGGIUNGI COSTO TRASPORTI AL BUDGET ==
    // ==========================================================================
    const handleCalculateAndAddTransportCost = () => { if (!currentTripId) { showToast("Seleziona un viaggio.", "error"); return; } const trip = findTripById(currentTripId); if (!trip || !Array.isArray(trip.transportations)) { showToast("Errore dati trasporti.", "error"); return; } let totalCost = 0; trip.transportations.forEach(item => { const cost = Number(item?.cost || 0); if (!isNaN(cost) && cost > 0) { totalCost += cost; } }); if (totalCost <= 0) { showToast("Nessun costo trasporto trovato.", "info"); return; } const item = { id: generateId('budget'), category: "Trasporti", description: `Totale Costi Trasporti (del ${formatDate(new Date().toISOString().slice(0,10))})`, estimated: totalCost, actual: null }; trip.budget = (trip.budget && typeof trip.budget === 'object') ? trip.budget : { items: [], estimatedTotal: 0, actualTotal: 0 }; trip.budget.items = Array.isArray(trip.budget.items) ? trip.budget.items : []; trip.budget.items.push(item); saveTrips(); renderBudget(trip.budget); showToast(`Costo trasporti (${formatCurrency(totalCost)}) aggiunto al budget!`, 'success'); switchTab('budget-tab'); };

    // ==========================================================================
    // == FUNZIONI UI (Tabs) ==
    // ==========================================================================
    const switchTab = (tabId) => { if (!tabId) { console.error("switchTab: tabId mancante"); return; } document.querySelectorAll(".tab-content").forEach(tab => { tab.style.display = "none"; tab.classList.remove("active"); }); document.querySelectorAll(".tab-link").forEach(link => link.classList.remove("active")); const content = document.getElementById(tabId); const link = tabsContainer ? tabsContainer.querySelector(`.tab-link[data-tab="${tabId}"]`) : null; if (content) { content.style.display = "block"; setTimeout(() => content.classList.add("active"), 10); } else { console.error(`Contenuto tab "${tabId}" non trovato!`); } if (link) { link.classList.add("active"); } else { console.error(`Link tab "${tabId}" non trovato!`); } };

    // ==========================================================================
    // == FUNZIONI DOWNLOAD ==
    // ==========================================================================
    const handleDownloadText = () => { if (!currentTripId) { showToast("Seleziona un viaggio.", "error"); return; } const trip = findTripById(currentTripId); if (!trip) return; let content = `Riepilogo Viaggio: ${trip.name || 'S.N.'}\n========================\n\n`; content += `**INFO**\nDest.: ${trip.destinationIata || 'N/D'}\nOrigine: ${trip.originIata || 'N/D'}\nDate: ${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}\nNote: ${trip.notes || '-'}\n\n`; content += `**TRASPORTI** (${(trip.transportations || []).length})\n`; (trip.transportations || []).slice().sort((a,b)=>(a?.departureDateTime||'').localeCompare(b?.departureDateTime||'')).forEach(i => { content += `- ${i.type} (${i.description}): Da ${i.departureLoc||'?'} (${formatDateTime(i.departureDateTime)}) a ${i.arrivalLoc||'?'} (${formatDateTime(i.arrivalDateTime)})${i.cost!==null ? ' Costo: '+formatCurrency(i.cost):''}${i.bookingRef ? ' Rif: '+i.bookingRef:''}${i.notes ? ' Note: '+i.notes:''}\n` }); if((trip.transportations || []).length === 0) content += "Nessuno\n"; content += "\n"; content += `**ITINERARIO** (${(trip.itinerary || []).length})\n`; (trip.itinerary || []).slice().sort((a,b)=>{const d=(a?.day||'').localeCompare(b?.day||''); return d!==0?d:(a?.time||'').localeCompare(b?.time||'');}).forEach(i => { content += `- ${formatDate(i.day)}${i.time?' ('+i.time+')':''} ${i.activity}${i.location?' @'+i.location:''}${i.notes?' ('+i.notes+')':''}\n` }); if((trip.itinerary || []).length === 0) content += "Nessuno\n"; content += "\n"; content += `**BUDGET** (${(trip.budget?.items || []).length} voci)\n`; (trip.budget?.items || []).slice().sort((a,b)=>(a?.category||'').localeCompare(b?.category||'')).forEach(i => { content += `- ${i.category}: ${i.description} (Est: ${formatCurrency(i.estimated)}, Act: ${i.actual===null?'N/A':formatCurrency(i.actual)})\n` }); if((trip.budget?.items || []).length > 0) content += `> Tot Est: ${formatCurrency(trip.budget.estimatedTotal)}, Tot Act: ${formatCurrency(trip.budget.actualTotal)}, Diff: ${formatCurrency(trip.budget.actualTotal - trip.budget.estimatedTotal)}\n`; else content += "Nessuna spesa\n"; content += "\n"; content += `**PACKING LIST** (${(trip.packingList || []).length})\n`; (trip.packingList || []).slice().sort((a,b)=>(a?.name||'').localeCompare(b?.name||'')).forEach(i => { content += `- [${i.packed?'X':' '}] ${i.name}\n` }); if((trip.packingList || []).length === 0) content += "Lista vuota\n"; const blob = new Blob([content],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`Viaggio-${(trip.name||'SN').replace(/[^a-z0-9]/gi,'_')}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
    const handleDownloadExcel = () => { if (!currentTripId) { showToast("Seleziona un viaggio.", "error"); return; } const trip = findTripById(currentTripId); if (!trip) return; try { const wb = XLSX.utils.book_new(); const cf = '#,##0.00 €'; const summary = [ ["Voce","Dettaglio"], ["Viaggio", trip.name||'S.N.'], ["Origine IATA", trip.originIata||'N/D'], ["Dest. IATA", trip.destinationIata||'N/D'], ["Periodo", `${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}`], [], ["Budget Est.",{t:'n',v:trip.budget.estimatedTotal,z:cf}], ["Budget Act.",{t:'n',v:trip.budget.actualTotal,z:cf}], ["Diff.",{t:'n',v:trip.budget.actualTotal-trip.budget.estimatedTotal,z:cf}], [], ["# Trasporti", (trip.transportations||[]).length], ["# Itin.", (trip.itinerary||[]).length], ["# Budget", (trip.budget?.items||[]).length], ["# Packing", (trip.packingList||[]).length]]; const wsSum = XLSX.utils.aoa_to_sheet(summary); wsSum['!cols']=[{wch:15},{wch:40}]; XLSX.utils.book_append_sheet(wb, wsSum, "Riepilogo"); const th = ["Tipo","Desc.","Da Luogo","Da Data/Ora","A Luogo","A Data/Ora","Rif.","Costo","Note"]; const td = (trip.transportations||[]).slice().sort((a,b)=>(a?.departureDateTime||'').localeCompare(b?.departureDateTime||'')).map(i=>[i.type, i.description, i.departureLoc, formatDateTime(i.departureDateTime), i.arrivalLoc, formatDateTime(i.arrivalDateTime), i.bookingRef, i.cost===null?null:{t:'n',v:i.cost,z:cf}, i.notes]); const wsT = XLSX.utils.aoa_to_sheet([th, ...td]); wsT['!cols']=[{wch:12},{wch:25},{wch:18},{wch:16},{wch:18},{wch:16},{wch:15},{wch:12},{wch:25}]; XLSX.utils.book_append_sheet(wb, wsT, "Trasporti"); const ih = ["Giorno","Ora","Attività","Luogo","Note"]; const idata = (trip.itinerary||[]).slice().sort((a,b)=>{const d=(a?.day||'').localeCompare(b?.day||''); return d!==0?d:(a?.time||'').localeCompare(b?.time||'');}).map(i=>[formatDate(i.day),i.time,i.activity,i.location,i.notes]); const wsI = XLSX.utils.aoa_to_sheet([ih, ...idata]); wsI['!cols']=[{wch:10},{wch:8},{wch:30},{wch:25},{wch:30}]; XLSX.utils.book_append_sheet(wb, wsI, "Itinerario"); const bh = ["Cat.","Desc.","Est. (€)","Act. (€)"]; const bd = (trip.budget?.items||[]).slice().sort((a,b)=>(a?.category||'').localeCompare(b?.category||'')).map(i=>[i.category,i.description,{t:'n',v:i.estimated||0,z:cf},i.actual===null?null:{t:'n',v:i.actual,z:cf}]); bd.push([],["TOTALI","", {t:'n',v:trip.budget.estimatedTotal,z:cf}, {t:'n',v:trip.budget.actualTotal,z:cf}]); const wsB = XLSX.utils.aoa_to_sheet([bh, ...bd]); wsB['!cols']=[{wch:15},{wch:35},{wch:15},{wch:15}]; XLSX.utils.book_append_sheet(wb, wsB, "Budget"); const ph = ["Oggetto","Fatto?"]; const pd = (trip.packingList||[]).slice().sort((a,b)=>(a?.name||'').localeCompare(b?.name||'')).map(i=>[i.name,i.packed?'Sì':'No']); const wsP = XLSX.utils.aoa_to_sheet([ph, ...pd]); wsP['!cols']=[{wch:40},{wch:8}]; XLSX.utils.book_append_sheet(wb, wsP, "Packing List"); const fn = `Viaggio-${(trip.name||'SN').replace(/[^a-z0-9]/gi,'_')}.xlsx`; XLSX.writeFile(wb, fn); } catch(e){ console.error("Err Excel:",e); showToast("Errore creazione Excel.", "error"); } };

    // ==========================================================================
    // == FUNZIONE RICERCA VOLI SKYSCANNER ==
    // ==========================================================================
     const handleSearchFlights = () => {
        if (!currentTripId) { showToast("Seleziona un viaggio.", "error"); return; }
        const trip = findTripById(currentTripId); if (!trip) { showToast("Viaggio non trovato.", "error"); return; }
        const originCode = trip.originIata || 'anywhere'; const destinationCode = trip.destinationIata || 'anywhere';
        const startDateRaw = trip.startDate || ''; const endDateRaw = trip.endDate || '';
        const startDateSkyscanner = formatSkyscannerDate(startDateRaw); const endDateSkyscanner = formatSkyscannerDate(endDateRaw);
        if (originCode === 'anywhere' || destinationCode === 'anywhere') { showToast("Inserisci i codici IATA nel tab 'Info'.", "warning"); return; }
        if (!startDateSkyscanner || !endDateSkyscanner) { showToast("Inserisci date valide nel tab 'Info'.", "warning"); return; }
        if (startDateRaw && endDateRaw && startDateRaw > endDateRaw) { showToast("Data ritorno non valida.", "warning"); return; }
        const baseUrl = "https://www.skyscanner.it/trasporti/voli/";
        const searchUrl = `${baseUrl}${originCode}/${destinationCode}/${startDateSkyscanner}/${endDateSkyscanner}/?rtn=1&adults=1&children=0&infants=0&cabinclass=economy&preferdirects=false`;
        console.log("Apertura URL Skyscanner:", searchUrl); window.open(searchUrl, '_blank', 'noopener,noreferrer');
    };

    // ==========================================================================
    // == INIZIALIZZAZIONE E EVENT LISTENER ==
    // ==========================================================================
    const init = () => {
        loadTrips(); renderTripList(); deselectTrip();

        // Listener Globali
        newTripBtn.addEventListener('click', handleNewTrip);
        tripInfoForm.addEventListener('submit', handleSaveTripInfo);
        deleteTripBtn.addEventListener('click', () => { if (currentTripId) handleDeleteTrip(currentTripId); });
        downloadTextBtn.addEventListener('click', handleDownloadText);
        downloadExcelBtn.addEventListener('click', handleDownloadExcel);
        tabsContainer.addEventListener('click', (e) => { const tl = e.target.closest('.tab-link'); if (tl?.dataset.tab) switchTab(tl.dataset.tab); });

        // Listener Submit Forms
        addTransportItemForm.addEventListener('submit', (e) => handleItemFormSubmit(e, 'transport'));
        addItineraryItemForm.addEventListener('submit', (e) => handleItemFormSubmit(e, 'itinerary'));
        addBudgetItemForm.addEventListener('submit', (e) => handleItemFormSubmit(e, 'budget'));
        addPackingItemForm.addEventListener('submit', (e) => handleItemFormSubmit(e, 'packing'));

        // Listener Annulla Modifica
        transportCancelEditBtn.addEventListener('click', () => resetEditState('transport'));
        itineraryCancelEditBtn.addEventListener('click', () => resetEditState('itinerary'));
        budgetCancelEditBtn.addEventListener('click', () => resetEditState('budget'));
        packingCancelEditBtn.addEventListener('click', () => resetEditState('packing'));

         // Listener Delegati per Azioni Liste
        tripDetailsAreaDiv.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.btn-icon.edit'); const deleteBtn = e.target.closest('.btn-icon.delete'); const packingCheckbox = e.target.closest('.packing-checkbox');
            if (editBtn) { const itemId = editBtn.dataset.itemId; if(!itemId) return; if (editBtn.classList.contains('transport-edit-btn')) startEditItem('transport', itemId); else if (editBtn.classList.contains('itinerary-edit-btn')) startEditItem('itinerary', itemId); else if (editBtn.classList.contains('budget-edit-btn')) startEditItem('budget', itemId); else if (editBtn.classList.contains('packing-edit-btn')) startEditItem('packing', itemId); }
            else if (deleteBtn) { const itemId = deleteBtn.dataset.itemId; if(!itemId) return; if (deleteBtn.classList.contains('transport-delete-btn')) handleDeleteItem('transport', itemId); else if (deleteBtn.classList.contains('itinerary-delete-btn')) handleDeleteItem('itinerary', itemId); else if (deleteBtn.classList.contains('budget-delete-btn')) handleDeleteItem('budget', itemId); else if (deleteBtn.classList.contains('packing-delete-btn')) handleDeleteItem('packing', itemId); }
            else if (packingCheckbox) { const itemId = packingCheckbox.dataset.itemId; if(itemId) handleTogglePacked(itemId, packingCheckbox.checked); packingCheckbox.closest('li').classList.toggle('packed', packingCheckbox.checked); }
        });

         // Listener Import Checklist
         if (predefinedChecklistsContainer) { predefinedChecklistsContainer.addEventListener('click', (e) => { const btn = e.target.closest('button[data-checklist]'); if (btn?.dataset.checklist) handleImportPackingList(btn.dataset.checklist); }); } else { console.warn("Contenitore checklist predefinite non trovato."); }

         // Listener Modals
         if (newTripModal) { createTripConfirmBtn?.addEventListener('click', handleCreateTripConfirm); newTripModal.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', closeNewTripModal)); newTripNameInput?.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleCreateTripConfirm(); }); newTripModal.addEventListener('click', (e) => { if (e.target === newTripModal) closeNewTripModal(); }); } else { console.warn("Modal nuovo viaggio non trovato."); }
         if (confirmationModal) { const confirmBtn = confirmationModal.querySelector('#confirmation-modal-confirm-btn'); const closeBtns = confirmationModal.querySelectorAll('.modal-close'); if(confirmBtn) { const newConfirmBtn = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn); newConfirmBtn.addEventListener('click', () => { if (typeof confirmActionCallback === 'function') confirmActionCallback(); closeConfirmationModal(); }); } else { console.error("Bottone conferma modal non trovato"); } closeBtns.forEach(btn => btn.addEventListener('click', closeConfirmationModal)); confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) closeConfirmationModal(); }); } else { console.warn("Modal conferma non trovato."); }

         // Listener Calcolo Budget Trasporti
         if (addTransportTotalToBudgetBtn) { addTransportTotalToBudgetBtn.addEventListener('click', handleCalculateAndAddTransportCost); } else { console.warn("Bottone calcolo budget trasporti non trovato."); }

         // Listener Cerca Voli Skyscanner
         if (searchSkyscannerBtn) { searchSkyscannerBtn.addEventListener('click', handleSearchFlights); } else { console.warn("Bottone cerca voli non trovato."); }

    }; // Fine init

    // Avvia app
    init();

}); // Fine DOMContentLoaded
